<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="format-detection" content="telephone=no"/>
  <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
  <meta name="viewport"
        content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi"/>
  <link rel="stylesheet" type="text/css" href="index.css"/>
  <title>Beer Challenge</title>
</head>
<body>
<div class="flip">
  <div class="card">
    <div class="face front">
      <img class="nexus7reso" src="img/aloitus.png"/>
    </div>
    <div class="face back">
      <div class="seconds">0</div>
      <div class="tenths">0</div>
      <img class="nexus7reso" src="img/timer-zero.png"/>
    </div>
  </div>
</div>

<script type="text/javascript" src="cordova.js"></script>
<script type="text/javascript" src="js/lodash.min.js"></script>
<script type="text/javascript" src="js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
  var trembleThreshold = 2.2

  bindUIfunctionality()
  warmupUIforFastFirstResponse()
  document.addEventListener('deviceready', onDeviceReady, false)
  var startTime = 0
  var stopTime = 0

  function warmupUIforFastFirstResponse() {
    $('.card').addClass('flipped')
    window.requestAnimationFrame(function() {
      $('.card').removeClass('flipped')
    })
  }

  function bindUIfunctionality() {
    $('.card').on('touchstart mousedown',function() {
      $(this).addClass('flipped')
    }).on('touchend mouseup', function() {
          if (startTime == 0) {
            startTime = Date.now()
            updateTime()
          }
        })
    //Disable scrolling of view (when Android navigation menu is shown)
    document.addEventListener('touchmove', function(e) {
      e.preventDefault()
    }, false)
    document.addEventListener("backbutton", onBackButton, false)

    function onBackButton() {
      $('.card').removeClass('flipped')
    }

    function updateTime() {
      var elapsedMillis = Date.now() - startTime
      var secs = Math.floor(elapsedMillis / 1000)
      if (secs > $('.seconds').text()) {
        if (secs == 10) {
          $(".seconds").css('font-size', 230)
        } else if (secs == 100) {
          $(".seconds").css('font-size', 185)
        } else if (secs > 100) {
          var sizePx = $(".seconds").css('font-size')
          $(".seconds").css('font-size', sizePx.substring(0, sizePx.indexOf('px')) - 1)
        }
        $(".seconds").text(secs)
      }
      $('.tenths').text(Math.floor(elapsedMillis / 100) % 10)
      if (stopTime == 0) {
        window.requestAnimationFrame(updateTime)
      }
    }
  }

  function onDeviceReady() {
    var maxPrev = 0
    var accPrev = undefined
    navigator.accelerometer.watchAcceleration(onSuccess, function(e) {
      alert('Accel error', e)
    }, {frequency: 10})

    function onSuccess(acceleration) {
      var acc = [acceleration.x, acceleration.y, acceleration.z]
      if (accPrev) {
        var change = _.zip(accPrev, acc).map(function(vals) {
          return _.reduce(vals, function(sum, num) {
            return sum - num
          })
        })
        var maxNow = Math.max.apply(Math, _.map(change, Math.abs))
        maxPrev = Math.max(maxNow, maxPrev)
        if (maxPrev > trembleThreshold) {
          stopTime = Date.now()
        }
      }
      accPrev = acc
    }
  }
</script>

</body>
</html>
